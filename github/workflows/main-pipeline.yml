name: 'V2V Publisher - Fixed & Timeout Protected'

on:
  # Ø§Ø¬Ø±Ø§ Ù‡Ø± 4 Ø³Ø§Ø¹Øª ÛŒÚ©Ø¨Ø§Ø± (Ú©Ù…ØªØ± ÙØ´Ø§Ø± Ø¨Ù‡ Ø³Ø±ÙˆØ±)
  schedule:
    - cron: '0 */4 * * *' 
  workflow_dispatch:
  
# âœ… Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† timeout Ú©Ù„ÛŒ Ø¨Ø±Ø§ÛŒ workflow
env:
  WORKFLOW_TIMEOUT_MINUTES: 50

jobs:
  scrape_and_commit:
    runs-on: ubuntu-latest
    environment: Production
    # âœ… ØªÙ†Ø¸ÛŒÙ… timeout Ø¨Ø±Ø§ÛŒ Ú©Ù„ job
    timeout-minutes: 45
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        # âœ… Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† timeout Ø¨Ø±Ø§ÛŒ checkout
        timeout-minutes: 5

    - name: Setup Python environment
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
      timeout-minutes: 5

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests PyGithub PyYAML
      timeout-minutes: 5

    # âœ… Ø¨Ø±Ø±Ø³ÛŒ sources.json Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§
    - name: Validate sources file
      run: |
        if [ ! -f "sources.json" ]; then
          echo "ERROR: sources.json not found!"
          echo '{"static": ["https://example.com/sub1", "https://example.com/sub2"]}' > sources.json
        fi
        python -c "import json; json.load(open('sources.json'))" || exit 1
        echo "âœ… sources.json is valid"
      timeout-minutes: 2

    # âœ… Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ø§ timeout Ùˆ error handling
    - name: Execute Scraper script
      run: |
        echo "ğŸš€ Starting scraper with timeout protection..."
        timeout 2400 python scraper.py || {
          exit_code=$?
          if [ $exit_code -eq 124 ]; then
            echo "â° Scraper timed out after 40 minutes"
            echo "Creating minimal output files to prevent workflow failure..."
            
            # Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ minimal Ø¯Ø± ØµÙˆØ±Øª timeout
            echo '{"xray": {"vless": [], "vmess": [], "trojan": [], "ss": []}, "singbox": {"vless": [], "vmess": [], "trojan": [], "ss": [], "hy2": [], "tuic": []}}' > all_live_configs.json
            echo 'proxies: []' > clash_subscription.yml
            echo $(date +%s) > cache_version.txt
            
            echo "âš ï¸ Minimal files created due to timeout"
          else
            echo "âŒ Scraper failed with exit code: $exit_code"
            exit 1
          fi
        }
        
        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ
        if [ ! -f "all_live_configs.json" ] || [ ! -f "clash_subscription.yml" ] || [ ! -f "cache_version.txt" ]; then
          echo "âŒ Required output files missing!"
          exit 1
        fi
        
        echo "âœ… Scraper completed successfully"
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
        # âœ… Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† GitHub search Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² timeout
        GITHUB_SEARCH_LIMIT: 30
      timeout-minutes: 42

    - name: Configure Git for commit
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
      timeout-minutes: 2
        
    # âœ… Ø¨Ù‡Ø¨ÙˆØ¯ commit process
    - name: Commit and Push new files (GitHub Mirror)
      run: |
        echo "ğŸ“ Checking for changes..."
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ø¯Ø§Ø²Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡
        if [ -f "all_live_configs.json" ]; then
          config_size=$(wc -c < "all_live_configs.json")
          echo "ğŸ“Š Config file size: $config_size bytes"
          
          if [ "$config_size" -lt 100 ]; then
            echo "âš ï¸ Config file too small, may indicate error"
          fi
        fi
        
        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
        git add all_live_configs.json clash_subscription.yml cache_version.txt
        
        # Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ±Ø§Øª
        if git diff --cached --exit-code; then
          echo "â„¹ï¸ No changes detected. Skipping commit."
        else
          echo "âœ… Changes detected. Committing..."
          
          # Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ configs
          xray_count=$(python3 -c "import json; data=json.load(open('all_live_configs.json')); print(sum(len(v) for v in data.get('xray', {}).values()))" 2>/dev/null || echo "0")
          singbox_count=$(python3 -c "import json; data=json.load(open('all_live_configs.json')); print(sum(len(v) for v in data.get('singbox', {}).values()))" 2>/dev/null || echo "0")
          
          commit_msg="ğŸ¤– V2V Auto-Update: Xray($xray_count) + Sing-box($singbox_count) configs [$(date -u '+%Y-%m-%d %H:%M UTC')]"
          
          git commit -m "$commit_msg"
          git push
          
          echo "âœ… Files committed and pushed successfully"
        fi
      timeout-minutes: 5
        
  multi_mirror_deploy:
    runs-on: ubuntu-latest
    needs: scrape_and_commit
    # âœ… Ø§Ø¬Ø±Ø§ Ø­ØªÛŒ Ø¯Ø± ØµÙˆØ±Øª partial failure job Ù‚Ø¨Ù„ÛŒ
    if: always() && (needs.scrape_and_commit.result == 'success' || needs.scrape_and_commit.result == 'failure')
    timeout-minutes: 15
    
    steps:
    - name: Checkout code (Fetch committed files)
      uses: actions/checkout@v4
      with:
        # âœ… Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø®Ø±ÛŒÙ† commit
        ref: ${{ github.ref }}
      timeout-minutes: 3

    # âœ… Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù„Ø§Ø²Ù… Ù‚Ø¨Ù„ Ø§Ø² deploy
    - name: Validate output files
      run: |
        echo "ğŸ” Validating output files..."
        
        required_files=("all_live_configs.json" "clash_subscription.yml" "cache_version.txt")
        
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ Missing file: $file"
            echo "Creating placeholder..."
            case $file in
              "all_live_configs.json")
                echo '{"xray": {}, "singbox": {}}' > "$file"
                ;;
              "clash_subscription.yml")
                echo 'proxies: []' > "$file"
                ;;
              "cache_version.txt")
                echo $(date +%s) > "$file"
                ;;
            esac
          else
            echo "âœ… Found: $file ($(wc -c < "$file") bytes)"
          fi
        done
        
        # Ø¨Ø±Ø±Ø³ÛŒ validity ÙØ§ÛŒÙ„ JSON
        python3 -c "import json; json.load(open('all_live_configs.json'))" || {
          echo "âš ï¸ Invalid JSON detected. Creating valid placeholder."
          echo '{"xray": {}, "singbox": {}}' > all_live_configs.json
        }
        
        echo "âœ… All files validated"
      timeout-minutes: 2

    # Deploy to Vercel Mirror
    - name: Deploy to Vercel Mirror
      id: vercel_deploy
      uses: amondnet/vercel-action@v25 
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'
      continue-on-error: true
      timeout-minutes: 8

    # Deploy to Arvan Cloud Object Storage
    - name: Deploy to Arvan Cloud Object Storage (S3 Sync)
      id: arvan_deploy
      uses: jakejarvis/s3-sync-action@master
      with:
        args: --acl public-read --delete --exclude ".git/*" --exclude ".github/*" --exclude "*.py" --exclude "README.md"
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.ARVAN_ACCESS_KEY }} 
        AWS_SECRET_ACCESS_KEY: ${{ secrets.ARVAN_SECRET_ACCESS_KEY }}
        AWS_S3_ENDPOINT: 'https://s3.ir-thr-at1.arvanstorage.ir' 
        AWS_S3_BUCKET: ${{ secrets.ARVAN_BUCKET_NAME }} 
        SOURCE_DIR: '.'
      continue-on-error: true
      timeout-minutes: 5
      
    # Final Deploy Status Report with better formatting
    - name: Final Deploy Status Report
      if: always() 
      run: |
        echo "============================================"
        echo "ğŸš€ DEPLOYMENT STATUS REPORT"
        echo "============================================"
        
        vercel_status="${{ steps.vercel_deploy.outcome }}"
        arvan_status="${{ steps.arvan_deploy.outcome }}"
        scraper_status="${{ needs.scrape_and_commit.result }}"
        
        echo "ğŸ“Š Job Results:"
        echo "   - Scraper: $scraper_status"
        echo "   - Vercel: $vercel_status"
        echo "   - Arvan: $arvan_status"
        echo ""
        
        # Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ configs
        if [ -f "all_live_configs.json" ]; then
          total_configs=$(python3 -c "
          import json
          try:
              data = json.load(open('all_live_configs.json'))
              xray_total = sum(len(v) for v in data.get('xray', {}).values())
              singbox_total = sum(len(v) for v in data.get('singbox', {}).values())
              print(f'Xray: {xray_total}, Sing-box: {singbox_total}, Total: {xray_total + singbox_total}')
          except:
              print('Error reading config file')
          " 2>/dev/null || echo "Could not calculate totals")
          echo "ğŸ“ˆ Configs: $total_configs"
        fi
        
        echo ""
        echo "ğŸŒ Mirror Status:"
        echo "   - GitHub Pages: âœ… Active (Primary)"
        
        if [ "$vercel_status" = "success" ]; then
          echo "   - Vercel: âœ… Deployed"
        else
          echo "   - Vercel: âŒ Failed"
        fi
        
        if [ "$arvan_status" = "success" ]; then
          echo "   - Arvan Cloud: âœ… Deployed"
        else
          echo "   - Arvan Cloud: âŒ Failed"
        fi
        
        echo ""
        
        # ØªØ¹ÛŒÛŒÙ† ÙˆØ¶Ø¹ÛŒØª Ù†Ù‡Ø§ÛŒÛŒ
        if [ "$vercel_status" = "failure" ] && [ "$arvan_status" = "failure" ]; then
          echo "âš ï¸ WARNING: All secondary mirrors failed!"
          echo "ğŸ”„ Only GitHub Pages mirror is active."
          echo "ğŸ”§ Check secrets and service availability."
        elif [ "$vercel_status" = "failure" ] || [ "$arvan_status" = "failure" ]; then
          echo "âš ï¸ PARTIAL: One mirror failed, others operational."
          echo "âœ… Service continuity maintained."
        else
          echo "âœ… SUCCESS: All mirrors updated successfully!"
          echo "ğŸ¯ Full redundancy achieved."
        fi
        
        echo "============================================"
        echo "â° Completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "============================================"
      timeout-minutes: 2