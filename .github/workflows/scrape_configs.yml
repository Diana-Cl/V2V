name: Scheduled Scrape and Build

on:
  schedule:
    # Ø§Ø¬Ø±Ø§ Ù‡Ø± Û¸ Ø³Ø§Ø¹Øª ÛŒÚ©â€ŒØ¨Ø§Ø±
    - cron: "0 */8 * * *"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-commit:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    timeout-minutes: 45  # Ø§ÙØ²Ø§ÛŒØ´ Ø¨Ù‡ 45 Ø¨Ø±Ø§ÛŒ handle Ú©Ø±Ø¯Ù† Ù¾Ø§Ø±Ø³ÛŒÙ†Ú¯ Ù¾ÛŒØ´Ø±ÙØªÙ‡
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0  # Ø§Ø¶Ø§ÙÙ‡: Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ú©Ù„ÙˆÙ† Ø¹Ù…ÛŒÙ‚ Ø¨Ø±Ø§ÛŒ handle Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯

      - name: Validate Secrets
        run: |
          if [ -z "$GH_PAT" ]; then
            echo "::error::GH_PAT secret is missing or empty."
            exit 1
          fi
        env:
          GH_PAT: ${{ secrets.GH_PAT }}

      - name: Create dummy download test file
        run: |
          echo "::debug::Creating dummy download test file..."
          dd if=/dev/zero of=dl-test.bin bs=100k count=1
          echo "::info::Download test file created."

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"  # Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ latest stable Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ø§ Ø¨Ù‡Ø¨ÙˆØ¯Ù‡Ø§ÛŒ main.py

      - name: Install dependencies
        run: |
          echo "::debug::Installing dependencies..."
          pip install --upgrade pip
          pip install requests PyYAML PyGithub awscli  # ØªØ£ÛŒÛŒØ¯ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ main.py
          echo "::info::Dependencies installed."

      - name: Run scraper script
        run: |
          echo "::debug::Running scraper script..."
          if [ -z "$GH_PAT" ]; then
            echo "::error::GH_PAT not set, skipping scraper."
            exit 1
          fi
          python main.py  # ØªØºÛŒÛŒØ± Ù†Ø§Ù… ÙØ§ÛŒÙ„ Ø¨Ù‡ main.py Ù…Ø·Ø§Ø¨Ù‚ Ø§ØµÙ„Ø§Ø­Ø§Øª
          echo "::info::Scraper script completed successfully."
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        timeout-minutes: 40

      - name: Check for New Changes
        run: |
          echo "::debug::Checking for new changes..."
          if [ -d "./configs" ] && [ "$(ls -A ./configs)" ]; then
            echo "::info::Configs directory exists and has content."
          else
            echo "::warning::No configs found, possibly due to fetch or parse errors."
          fi

      - name: Upload files to ArvanCloud
        if: success()
        continue-on-error: true
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.ARVAN_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.ARVAN_SECRET_KEY_SECRET }}
        run: |
          echo "::debug::Starting ArvanCloud upload..."
          if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
            echo "::warning::ArvanCloud secrets not found, skipping upload."
            exit 0
          fi
          ENDPOINT_URL="https://s3.ir-thr-at1.arvanstorage.com"
          BUCKET_NAME="s3://v2v-data"
          
          if [ -d "./configs" ]; then
            aws s3 sync ./configs "$BUCKET_NAME/" --endpoint-url "$ENDPOINT_URL" --acl public-read --cache-control "max-age=300" --exclude "*" --include "sub_*.txt" --include "*.yaml" --include "*.json"
            echo "::info::Configs synced to ArvanCloud."
          fi
          
          if [ -f "cache_version.txt" ]; then
            aws s3 cp cache_version.txt "$BUCKET_NAME/cache_version.txt" --endpoint-url "$ENDPOINT_URL" --acl public-read --content-type "text/plain" --cache-control "max-age=300"
            echo "::info::Cache version uploaded."
          fi
          if [ -f "dl-test.bin" ]; then
            aws s3 cp dl-test.bin "$BUCKET_NAME/dl-test.bin" --endpoint-url "$ENDPOINT_URL" --acl public-read --cache-control "max-age=3600"
            echo "::info::Download test file uploaded."
          fi

      - name: Cleanup Temporary Files
        run: |
          echo "::debug::Cleaning up temporary files..."
          rm -f dl-test.bin  # Cleanup Ø§Ú¯Ø± Ù†ÛŒØ§Ø² Ø¨Ø§Ø´Ù‡
          echo "::info::Cleanup completed."

      - name: Commit and Push final files to GitHub
        run: |
          echo "::debug::Preparing commit..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add configs/ cache_version.txt dl-test.bin
          
          if git diff --staged --quiet; then
            echo "::notice::No new changes to commit."
          else
            COMMIT_MESSAGE="ğŸ“Š Update configs [$(date -u '+%Y-%m-%d %H:%M:%S UTC')] [skip ci]"
            git commit -m "$COMMIT_MESSAGE"
            if git push; then
              echo "::info::Changes committed and pushed: $COMMIT_MESSAGE"
            else
              echo "::error::Push failed."
              exit 1
            fi
          fi