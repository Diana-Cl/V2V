name: Scheduled Scrape and Build

on:
  schedule:
    # Ù‡Ø± Û´ Ø³Ø§Ø¹Øª ÛŒÚ©â€ŒØ¨Ø§Ø± Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    - cron: "0 */4 * * *"
  # Ø§Ù…Ú©Ø§Ù† Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ Ø±Ø§ ÙØ±Ø§Ù‡Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯
  workflow_dispatch:

# FIX 1: Ø§ÙØ²ÙˆØ¯Ù† Ú©Ù†ØªØ±Ù„ Ù‡Ù…Ø²Ù…Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ú©Ø§Ù…Ù„ Ø§Ø² ØªØ¯Ø§Ø®Ù„ (Merge Conflict)
# Ø§ÛŒÙ† Ø¨Ø®Ø´ ØªØ¶Ù…ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ù‡Ù…ÛŒØ´Ù‡ ÙÙ‚Ø· ÛŒÚ© Ù†Ù…ÙˆÙ†Ù‡ Ø§Ø² Ø§ÛŒÙ† workflow Ø¨Ø±Ø§ÛŒ Ø´Ø§Ø®Ù‡ Ø§ØµÙ„ÛŒ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
# Ùˆ Ø¯Ø± ØµÙˆØ±Øª Ø´Ø±ÙˆØ¹ ÛŒÚ© Ø§Ø¬Ø±Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ØŒ Ø§Ø¬Ø±Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ù„ØºÙˆ Ú¯Ø±Ø¯Ø¯.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-commit:
    permissions:
      contents: write # Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ´ØªÙ† (commit & push) Ø¯Ø± Ø±ÛŒÙ¾Ø§Ø²ÛŒØªÙˆØ±ÛŒ
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² PAT Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¯Ø§Ø´ØªÙ† Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ù…Ù„ Ø¨Ø±Ø§ÛŒ push
          token: ${{ secrets.GH_PAT }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests PyYAML PyGithub awscli beautifulsoup4

      - name: Preserve previous clash subscription if it exists
        run: |
          if [ -f "clash_subscription.yaml" ]; then
            cp clash_subscription.yaml clash_subscription.yaml.bak
            echo "Backed up existing clash_subscription.yaml"
          fi

      - name: Run scraper script
        run: python scraper.py
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        timeout-minutes: 40

      - name: Check scraper output
        run: |
          echo "--- Scraper output files ---"
          ls -la
          if [ ! -f "all_live_configs.json" ]; then
            echo "::error::File all_live_configs.json was not created by the scraper."
          fi

      - name: Restore previous clash subscription if scraper failed
        # Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±ØªÛŒ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ú©Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„ÛŒ (Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª) Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´ÙˆØ¯
        if: failure()
        run: |
          if [ ! -f "clash_subscription.yaml" ] && [ -f "clash_subscription.yaml.bak" ]; then
            mv clash_subscription.yaml.bak clash_subscription.yaml
            echo "Scraper failed. Restored clash_subscription.yaml from backup."
          fi

      - name: Upload files to ArvanCloud
        continue-on-error: true
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.ARVAN_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.ARVAN_SECRET_KEY_SECRET }}
        run: |
          if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
            echo "::warning::ArvanCloud secrets not found, skipping upload."
            exit 0
          fi
          
          # FIX 2: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¢Ø¯Ø±Ø³ Ù¾Ø§ÛŒØ¯Ø§Ø±ØªØ± Ø¨Ø±Ø§ÛŒ ÙØ¶Ø§ÛŒ Ø§Ø¨Ø±ÛŒ Ø¢Ø±ÙˆØ§Ù†
          ENDPOINT_URL="https://s3.ir-thr-at1.arvanstorage.com"
          BUCKET_NAME="s3://v2v-data"
          
          # Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ Ùˆ Ú©Ù†ØªØ±Ù„ Ú©Ø´
          aws s3 cp all_live_configs.json "$BUCKET_NAME/all_live_configs.json" --endpoint-url "$ENDPOINT_URL" --acl public-read --cache-control "max-age=300"
          aws s3 cp clash_subscription.yaml "$BUCKET_NAME/clash_subscription.yaml" --endpoint-url "$ENDPOINT_URL" --acl public-read --cache-control "max-age=300"
          
          # Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ø´ØªÙ† ÛŒÚ© Ù†Ø³Ø®Ù‡ Ù…ÛŒØ±ÙˆØ± Ú©Ø§Ù…Ù„
          if [ -f "index.html" ]; then
            aws s3 cp index.html "$BUCKET_NAME/index.html" --endpoint-url "$ENDPOINT_URL" --acl public-read --content-type "text/html" --cache-control "max-age=300"
          fi

      - name: Generate Cache Buster Version
        run: |
          # Ø§ÛŒÙ† ÙØ§ÛŒÙ„ ÛŒÚ© timestamp Ø³Ø§Ø¯Ù‡ Ø§Ø³Øª ØªØ§ Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§ Ù†Ø³Ø®Ù‡ Ø¬Ø¯ÛŒØ¯ ÙØ§ÛŒÙ„ Ø¬ÛŒØ³ÙˆÙ† Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯
          echo "$(date +%s)" > cache_version.txt

      - name: Commit and Push final files to GitHub
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add all_live_configs.json clash_subscription.yaml cache_version.txt
          
          # Ø­Ø°Ù ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ù‚Ø¨Ù„ Ø§Ø² Ú©Ø§Ù…ÛŒØª Ù†Ù‡Ø§ÛŒÛŒ
          rm -f clash_subscription.yaml.bak
          
          # ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ø§Ù…ÛŒØª Ú©Ù† Ú©Ù‡ ØªØºÛŒÛŒØ±ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
          if git diff --staged --quiet; then
            echo "No new changes to commit."
          else
            git commit -m "ğŸ“Š Update configs [$(date -u '+%Y-%m-%d %H:%M:%S UTC')] [skip ci]"
            
            # FIX 3: Ø³Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ù†Ø·Ù‚ push
            # Ø¨Ø§ ÙˆØ¬ÙˆØ¯ 'concurrency'ØŒ Ø¯ÛŒÚ¯Ø± Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ pull Ú©Ø±Ø¯Ù† Ù‚Ø¨Ù„ Ø§Ø² push Ù†ÛŒØ³Øª
            # Ø§ÛŒÙ† Ø±ÙˆØ´ Ø¨Ø³ÛŒØ§Ø± Ø§Ù…Ù†â€ŒØªØ± Ùˆ ØªÙ…ÛŒØ²ØªØ± Ø§Ø³Øª
            git push
          fi
