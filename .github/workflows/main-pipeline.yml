name: 'V2V Complete Deploy'

on:
  schedule:
    - cron: '0 */3 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update_and_deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 1. Setup & Scrape
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_PAT || github.token }}

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Python Dependencies
      run: pip install requests PyGithub PyYAML boto3

    - name: Run Scraper
      run: timeout 2700 python scraper.py || true
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
        GITHUB_SEARCH_LIMIT: 150

    - name: Verify Generated Files
      run: |
        echo "ğŸ“ Checking files..."
        ls -lh all_live_configs.json clash_subscription.yml cache_version.txt 2>/dev/null || true
        echo ""
        [ -f all_live_configs.json ] && echo "âœ… all_live_configs.json" || echo "âŒ Missing"
        [ -f clash_subscription.yml ] && echo "âœ… clash_subscription.yml" || echo "âŒ Missing"
        [ -f cache_version.txt ] && echo "âœ… cache_version.txt" || echo "âŒ Missing"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 2. Commit to Git (for GitHub Pages)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Commit Configs
      run: |
        git config user.name "V2V Bot"
        git config user.email "bot@v2v.dev"
        git add all_live_configs.json clash_subscription.yml cache_version.txt
        git diff --quiet && git diff --staged --quiet || {
          git commit -m "ğŸ”„ Update: $(date -u '+%Y-%m-%d %H:%M UTC')"
          git push origin main
        }
      continue-on-error: true

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 3. Deploy to Arvan Cloud S3
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Install AWS CLI
      run: |
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "aws.zip"
        unzip -q aws.zip
        sudo ./aws/install --update

    - name: Deploy to Arvan S3
      run: |
        aws configure set aws_access_key_id ${{ secrets.ARVAN_ACCESS_KEY_ID }}
        aws configure set aws_secret_access_key ${{ secrets.ARVAN_SECRET_ACCESS_KEY }}
        aws configure set default.s3.signature_version s3v4
        
        echo "ğŸš€ Syncing to Arvan Cloud S3..."
        aws s3 sync . s3://${{ secrets.ARVAN_BUCKET_NAME }}/ \
          --endpoint-url=https://s3.ir-thr-at1.arvanstorage.ir \
          --exclude ".git/*" \
          --exclude ".github/*" \
          --exclude "*.py" \
          --exclude "*.pyc" \
          --exclude "__pycache__/*" \
          --exclude "*.zip" \
          --exclude "aws/*" \
          --exclude "node_modules/*" \
          --cache-control "no-cache, must-revalidate" \
          --acl public-read
        
        echo "âœ… Arvan deployment complete"
        echo "ğŸŒ https://${{ secrets.ARVAN_BUCKET_NAME }}.s3-website.ir-thr-at1.arvanstorage.ir/"
      continue-on-error: true

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 4. Deploy to Vercel
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Deploy to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod --yes'
      continue-on-error: true

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 5. Deploy Cloudflare Workers
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Wrangler
      run: npm install -g wrangler@latest

    - name: Deploy All Workers
      run: |
        echo "ğŸš€ Deploying Cloudflare Workers..."
        wrangler deploy --env v2v-proxy && echo "âœ… v2v-proxy" || echo "âŒ v2v-proxy failed"
        wrangler deploy --env v2v && echo "âœ… v2v" || echo "âŒ v2v failed"
        wrangler deploy --env winter-hill-0307 && echo "âœ… winter-hill-0307" || echo "âŒ winter-hill-0307 failed"
        wrangler deploy --env rapid-scene-1da6 && echo "âœ… rapid-scene-1da6" || echo "âŒ rapid-scene-1da6 failed"
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      continue-on-error: true

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 6. Summary
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Deployment Summary
      if: always()
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘           V2V DEPLOYMENT COMPLETED                   â•‘"
        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        echo "â•‘                                                      â•‘"
        echo "â•‘  ğŸŒ Live Sites:                                      â•‘"
        echo "â•‘                                                      â•‘"
        echo "â•‘  1ï¸âƒ£  Arvan Cloud:                                    â•‘"
        echo "â•‘     https://v2v-data.s3-website.ir-thr-at1.arvan... â•‘"
        echo "â•‘                                                      â•‘"
        echo "â•‘  2ï¸âƒ£  Vercel:                                         â•‘"
        echo "â•‘     https://v2v-vercel.vercel.app/                   â•‘"
        echo "â•‘                                                      â•‘"
        echo "â•‘  3ï¸âƒ£  GitHub Pages:                                   â•‘"
        echo "â•‘     https://smbcryp.github.io/V2V/                   â•‘"
        echo "â•‘                                                      â•‘"
        echo "â•‘  âš¡ Workers: 4 endpoints deployed                    â•‘"
        echo "â•‘                                                      â•‘"
        echo "â•‘  â° $(date -u '+%Y-%m-%d %H:%M:%S UTC')                          â•‘"
        echo "â•‘                                                      â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""