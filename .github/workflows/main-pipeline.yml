name: 'V2V Complete Deploy'

on:
  schedule:
    - cron: '0 */3 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update_and_deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_PAT || github.token }}

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: pip install requests PyGithub PyYAML

    - name: Run Scraper
      run: timeout 2700 python scraper.py || true
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
        GITHUB_SEARCH_LIMIT: 150

    - name: Check Generated Files
      run: |
        echo "ğŸ“ Generated Files:"
        ls -lh all_live_configs.json clash_subscription.yml cache_version.txt 2>/dev/null || echo "âš ï¸ Files missing"

    - name: Install AWS CLI
      run: |
        curl -s "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "aws.zip"
        unzip -q aws.zip
        sudo ./aws/install --update || sudo ./aws/install

    - name: Deploy to Arvan Cloud
      run: |
        aws configure set aws_access_key_id "${{ secrets.ARVAN_ACCESS_KEY_ID }}"
        aws configure set aws_secret_access_key "${{ secrets.ARVAN_SECRET_ACCESS_KEY }}"
        aws configure set default.region us-east-1
        
        BUCKET="${{ secrets.ARVAN_BUCKET_NAME }}"
        ENDPOINT="https://s3.ir-thr-at1.arvanstorage.ir"
        
        echo "ğŸš€ Uploading to Arvan Cloud: $BUCKET"
        
        for file in all_live_configs.json clash_subscription.yml cache_version.txt index.html index.js logo.png manifest.json; do
          if [ -f "$file" ]; then
            echo "ğŸ“¤ Uploading $file..."
            aws s3 cp "$file" "s3://$BUCKET/$file" \
              --endpoint-url="$ENDPOINT" \
              --acl public-read \
              --cache-control "no-cache, must-revalidate" \
              && echo "âœ… $file uploaded" \
              || echo "âŒ $file failed"
          else
            echo "âš ï¸  $file not found"
          fi
        done
        
        echo ""
        echo "ğŸŒ Arvan URL: https://$BUCKET.s3-website.ir-thr-at1.arvanstorage.ir/"
      continue-on-error: false

    - name: Commit Changes
      run: |
        git config user.name "V2V Bot"
        git config user.email "bot@v2v.dev"
        
        git add all_live_configs.json clash_subscription.yml cache_version.txt
        
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No changes to commit"
        else
          git commit -m "ğŸ”„ Update configs [skip ci]
          
          Automated update at $(date -u '+%Y-%m-%d %H:%M UTC')"
          git push
          echo "âœ… Committed to GitHub"
        fi

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Deploy to Vercel
      run: |
        npm install -g vercel@latest
        
        echo "ğŸš€ Deploying to Vercel..."
        vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }} 2>/dev/null || true
        vercel build --prod --token=${{ secrets.VERCEL_TOKEN }} 2>/dev/null || true
        vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }} && echo "âœ… Vercel deployed" || echo "âš ï¸ Vercel skipped"
      env:
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      continue-on-error: true

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Deploy Cloudflare Workers
      run: |
        npm install -g wrangler@latest
        
        echo "ğŸš€ Deploying Cloudflare Workers..."
        wrangler deploy --env v2v-proxy || echo "âŒ v2v-proxy failed"
        wrangler deploy --env v2v || echo "âŒ v2v failed"
        wrangler deploy --env winter-hill-0307 || echo "âŒ winter-hill-0307 failed"
        wrangler deploy --env rapid-scene-1da6 || echo "âŒ rapid-scene-1da6 failed"
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      continue-on-error: true

    - name: Deployment Summary
      if: always()
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘     âœ… V2V DEPLOYMENT COMPLETED            â•‘"
        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        echo "â•‘                                            â•‘"
        echo "â•‘  1ï¸âƒ£  Arvan Cloud Storage                   â•‘"
        echo "â•‘  2ï¸âƒ£  GitHub Pages                          â•‘"
        echo "â•‘  3ï¸âƒ£  Vercel                                â•‘"
        echo "â•‘  4ï¸âƒ£  Cloudflare Workers (4x)               â•‘"
        echo "â•‘                                            â•‘"
        echo "â•‘  â° $(date -u '+%Y-%m-%d %H:%M UTC')       â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"