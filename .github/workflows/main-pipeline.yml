name: 'V2V Deploy - All Sites'

on:
  workflow_dispatch:
  push:
    branches: [main]
  schedule:
    - cron: '0 */6 * * *'  # Ù‡Ø± 6 Ø³Ø§Ø¹Øª ÛŒÚ©Ø¨Ø§Ø±

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_PAT || github.token }}

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install Python Dependencies
      run: |
        pip install --upgrade pip
        pip install requests PyGithub PyYAML boto3

    - name: Run Scraper
      run: python scraper.py
      timeout-minutes: 40
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
        GITHUB_SEARCH_LIMIT: 150

    - name: Convert Configs to Client Formats
      run: python convert_configs.py

    - name: Verify Generated Files
      run: |
        echo "Checking generated files..."
        ls -lh *.json *.yaml *.yml 2>/dev/null || true
        echo "---"
        [ -f xray.json ] && echo "âœ“ xray.json exists" || echo "âœ— xray.json missing"
        [ -f singbox.json ] && echo "âœ“ singbox.json exists" || echo "âœ— singbox.json missing"
        [ -f clash.yaml ] && echo "âœ“ clash.yaml exists" || echo "âœ— clash.yaml missing"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Deploy 1: Arvan Cloud Storage
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Deploy to Arvan Cloud
      run: python upload_arvan.py
      env:
        ARVAN_ACCESS_KEY_ID: ${{ secrets.ARVAN_ACCESS_KEY_ID }}
        ARVAN_SECRET_ACCESS_KEY: ${{ secrets.ARVAN_SECRET_ACCESS_KEY }}
        ARVAN_BUCKET_NAME: ${{ secrets.ARVAN_BUCKET_NAME }}

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Deploy 2: GitHub Pages
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Commit and Push for GitHub Pages
      run: |
        git config user.name "V2V Bot"
        git config user.email "bot@v2v.dev"
        git add -A
        git diff --staged --quiet || git commit -m "ğŸ”„ Update configs $(date +'%Y-%m-%d %H:%M UTC')"
        git push origin main || echo "No changes to push"
      continue-on-error: true

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Deploy 3: Vercel
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Vercel CLI
      run: npm install -g vercel@latest

    - name: Deploy to Vercel (Production)
      run: |
        vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
      env:
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Deploy 4: Cloudflare Workers (Optional - for caching/proxy)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Install Wrangler
      run: npm install -g wrangler@latest

    - name: Deploy Cloudflare Workers
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      run: |
        echo "Deploying workers..."
        wrangler deploy --env v2v-proxy || echo "âš ï¸  v2v-proxy failed"
        wrangler deploy --env v2v || echo "âš ï¸  v2v failed"
        wrangler deploy --env winter-hill-0307 || echo "âš ï¸  winter-hill failed"
        wrangler deploy --env rapid-scene-1da6 || echo "âš ï¸  rapid-scene failed"
      continue-on-error: true

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Final Summary
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - name: Deployment Summary
      if: always()
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "       DEPLOYMENT SUMMARY"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸŒ Sites deployed:"
        echo "  1. Arvan Cloud: https://v2v-data.s3-website.ir-thr-at1.arvanstorage.ir/"
        echo "  2. Vercel: https://v2v-vercel.vercel.app/"
        echo "  3. GitHub Pages: https://smbcryp.github.io/V2V/"
        echo ""
        echo "â° Deployed at: $(date +'%Y-%m-%d %H:%M:%S UTC')"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"