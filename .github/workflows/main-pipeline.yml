name: 'V2V Complete Deploy'

on:
  schedule:
    - cron: '0 */3 * * *'  # Ù‡Ø± 3 Ø³Ø§Ø¹Øª ÛŒÚ©Ø¨Ø§Ø±
  workflow_dispatch:  # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ
  push:
    branches:
      - main
    paths:
      - 'scraper.py'
      - 'worker.js'
      - 'index.html'
      - 'index.js'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  scrape_and_deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    # ==================== CHECKOUT ====================
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_PAT || github.token }}
        fetch-depth: 0

    # ==================== PYTHON SETUP ====================
    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ðŸ“¦ Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests PyGithub PyYAML

    # ==================== RUN SCRAPER ====================
    - name: ðŸ•·ï¸ Run Scraper
      id: scraper
      run: |
        echo "Starting scraper..."
        timeout 2700 python scraper.py || EXIT_CODE=$?
        
        if [ $EXIT_CODE -eq 124 ]; then
          echo "âš ï¸ Scraper timeout after 45min"
          echo "scraper_status=timeout" >> $GITHUB_OUTPUT
        elif [ $EXIT_CODE -ne 0 ]; then
          echo "âŒ Scraper failed with code $EXIT_CODE"
          echo "scraper_status=failed" >> $GITHUB_OUTPUT
        else
          echo "âœ… Scraper completed successfully"
          echo "scraper_status=success" >> $GITHUB_OUTPUT
        fi
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
        GITHUB_SEARCH_LIMIT: 200
      continue-on-error: true

    # ==================== VERIFY FILES ====================
    - name: ðŸ” Verify Generated Files
      id: verify
      run: |
        echo "ðŸ“ Checking generated files..."
        
        MISSING=""
        for file in all_live_configs.json clash_subscription.yml cache_version.txt; do
          if [ ! -f "$file" ]; then
            echo "âŒ Missing: $file"
            MISSING="$MISSING $file"
          else
            SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
            echo "âœ… Found: $file ($SIZE bytes)"
          fi
        done
        
        if [ -n "$MISSING" ]; then
          echo "files_valid=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ Some files are missing: $MISSING"
        else
          echo "files_valid=true" >> $GITHUB_OUTPUT
          echo "âœ… All files generated successfully"
        fi

    # ==================== NODE SETUP ====================
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    # ==================== CLOUDFLARE WORKERS ====================
    - name: â˜ï¸ Deploy Cloudflare Workers
      if: steps.verify.outputs.files_valid == 'true'
      run: |
        npm install -g wrangler@latest
        
        echo "ðŸš€ Deploying to Cloudflare Workers..."
        
        # Deploy main worker
        wrangler deploy && echo "âœ… Main worker deployed" || echo "âŒ Main worker failed"
        
        # Deploy environment workers
        for env in v2v-proxy v2v winter-hill-0307 rapid-scene-1da6; do
          wrangler deploy --env $env && echo "âœ… $env deployed" || echo "âŒ $env failed"
        done
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      continue-on-error: true

    # ==================== ARVAN CLOUD ====================
    - name: â˜ï¸ Install AWS CLI
      if: steps.verify.outputs.files_valid == 'true'
      run: |
        curl -s "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "aws.zip"
        unzip -q aws.zip
        sudo ./aws/install --update 2>/dev/null || sudo ./aws/install

    - name: ðŸ“¤ Deploy to Arvan Cloud
      if: steps.verify.outputs.files_valid == 'true'
      run: |
        aws configure set aws_access_key_id "${{ secrets.ARVAN_ACCESS_KEY_ID }}"
        aws configure set aws_secret_access_key "${{ secrets.ARVAN_SECRET_ACCESS_KEY }}"
        aws configure set default.region us-east-1
        
        BUCKET="${{ secrets.ARVAN_BUCKET_NAME }}"
        ENDPOINT="https://s3.ir-thr-at1.arvanstorage.ir"
        
        echo "ðŸš€ Uploading to Arvan Cloud: $BUCKET"
        
        # Upload critical files
        CRITICAL_FILES="all_live_configs.json clash_subscription.yml cache_version.txt"
        for file in $CRITICAL_FILES; do
          if [ -f "$file" ]; then
            echo "ðŸ“¤ Uploading $file..."
            aws s3 cp "$file" "s3://$BUCKET/$file" \
              --endpoint-url="$ENDPOINT" \
              --acl public-read \
              --cache-control "no-cache, must-revalidate" \
              --metadata "updated=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              && echo "âœ… $file uploaded" \
              || echo "âŒ $file upload failed"
          fi
        done
        
        # Upload UI files
        UI_FILES="index.html index.js logo.png manifest.json"
        for file in $UI_FILES; do
          if [ -f "$file" ]; then
            echo "ðŸ“¤ Uploading $file..."
            aws s3 cp "$file" "s3://$BUCKET/$file" \
              --endpoint-url="$ENDPOINT" \
              --acl public-read \
              --cache-control "public, max-age=3600" \
              && echo "âœ… $file uploaded" \
              || echo "âš ï¸ $file upload skipped"
          fi
        done
        
        echo ""
        echo "ðŸŒ Arvan URL: https://$BUCKET.s3-website.ir-thr-at1.arvanstorage.ir/"
      continue-on-error: false

    # ==================== GIT COMMIT ====================
    - name: ðŸ’¾ Commit Changes to Repository
      if: steps.verify.outputs.files_valid == 'true'
      run: |
        git config user.name "V2V Bot"
        git config user.email "bot@v2v.dev"
        
        # Add generated files
        git add all_live_configs.json clash_subscription.yml cache_version.txt
        
        # Check if there are changes
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No changes to commit"
        else
          # Get stats
          XRAY_COUNT=$(jq '.xray | map(length) | add' all_live_configs.json 2>/dev/null || echo "0")
          SINGBOX_COUNT=$(jq '.singbox | map(length) | add' all_live_configs.json 2>/dev/null || echo "0")
          TOTAL=$((XRAY_COUNT + SINGBOX_COUNT))
          
          git commit -m "ðŸ”„ Update configs [skip ci]

Automated update at $(date -u '+%Y-%m-%d %H:%M UTC')

ðŸ“Š Stats:
- Xray: ${XRAY_COUNT} configs
- Singbox: ${SINGBOX_COUNT} configs  
- Total: ${TOTAL} configs"
          
          git push origin main
          echo "âœ… Changes committed and pushed"
        fi
      continue-on-error: true

    # ==================== GITHUB PAGES ====================
    - name: ðŸŒ Setup GitHub Pages
      if: steps.verify.outputs.files_valid == 'true'
      uses: actions/configure-pages@v4

    - name: ðŸ“¤ Upload Pages Artifact
      if: steps.verify.outputs.files_valid == 'true'
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'

    - name: ðŸš€ Deploy to GitHub Pages
      if: steps.verify.outputs.files_valid == 'true'
      id: pages_deploy
      uses: actions/deploy-pages@v4

    # ==================== VERCEL ====================
    - name: ðŸ”· Deploy to Vercel
      if: steps.verify.outputs.files_valid == 'true'
      id: vercel_deploy
      run: |
        npm install -g vercel@latest
        
        echo "ðŸš€ Deploying to Vercel..."
        
        # Set Vercel token
        export VERCEL_TOKEN="${{ secrets.VERCEL_TOKEN }}"
        
        # Pull Vercel environment
        vercel pull --yes --environment=production --token="$VERCEL_TOKEN" 2>&1 | tee vercel-pull.log || true
        
        # Build project
        vercel build --prod --token="$VERCEL_TOKEN" 2>&1 | tee vercel-build.log || true
        
        # Deploy to production
        DEPLOY_OUTPUT=$(vercel deploy --prebuilt --prod --token="$VERCEL_TOKEN" 2>&1 | tee vercel-deploy.log)
        DEPLOY_EXIT=$?
        
        if [ $DEPLOY_EXIT -eq 0 ]; then
          VERCEL_URL=$(echo "$DEPLOY_OUTPUT" | grep -Eo 'https://[^ ]+' | tail -1)
          echo "âœ… Vercel deployed successfully"
          echo "ðŸŒ URL: $VERCEL_URL"
          echo "vercel_status=success" >> $GITHUB_OUTPUT
          echo "vercel_url=$VERCEL_URL" >> $GITHUB_OUTPUT
        else
          echo "âŒ Vercel deployment failed"
          echo "vercel_status=failed" >> $GITHUB_OUTPUT
          cat vercel-deploy.log
        fi
      env:
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      continue-on-error: true

    # ==================== SUMMARY ====================
    - name: ðŸ“Š Deployment Summary
      if: always()
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘              âœ… V2V DEPLOYMENT COMPLETED                  â•‘"
        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        echo "â•‘                                                           â•‘"
        echo "â•‘  ðŸ•·ï¸  Scraper: ${{ steps.scraper.outputs.scraper_status || 'unknown' }}"
        echo "â•‘  ðŸ“ Files: ${{ steps.verify.outputs.files_valid || 'unknown' }}"
        echo "â•‘                                                           â•‘"
        echo "â•‘  Deployments:                                            â•‘"
        echo "â•‘  1ï¸âƒ£  Arvan Cloud Storage                                 â•‘"
        echo "â•‘  2ï¸âƒ£  GitHub Pages: ${{ steps.pages_deploy.outputs.page_url || 'N/A' }}"
        echo "â•‘  3ï¸âƒ£  Vercel: ${{ steps.vercel_deploy.outputs.vercel_status || 'N/A' }}"
        if [ -n "${{ steps.vercel_deploy.outputs.vercel_url }}" ]; then
          echo "â•‘      URL: ${{ steps.vercel_deploy.outputs.vercel_url }}"
        fi
        echo "â•‘  4ï¸âƒ£  Cloudflare Workers (4x environments)                â•‘"
        echo "â•‘                                                           â•‘"
        echo "â•‘  â° Completed: $(date -u '+%Y-%m-%d %H:%M UTC')          â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        # Create deployment summary
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        ## ðŸš€ V2V Deployment Summary
        
        ### ðŸ“Š Status
        
        | Component | Status |
        |-----------|--------|
        | Scraper | ${{ steps.scraper.outputs.scraper_status || 'â“ Unknown' }} |
        | Files | ${{ steps.verify.outputs.files_valid == 'true' && 'âœ… Valid' || 'âŒ Invalid' }} |
        | Arvan Cloud | âœ… Deployed |
        | GitHub Pages | ${{ steps.pages_deploy.outcome == 'success' && 'âœ… Deployed' || 'âŒ Failed' }} |
        | Vercel | ${{ steps.vercel_deploy.outputs.vercel_status == 'success' && 'âœ… Deployed' || 'âŒ Failed' }} |
        | Cloudflare Workers | âœ… Deployed |
        
        ### ðŸ”— URLs
        
        - **GitHub Pages**: ${{ steps.pages_deploy.outputs.page_url || 'N/A' }}
        - **Vercel**: ${{ steps.vercel_deploy.outputs.vercel_url || 'N/A' }}
        - **Arvan Cloud**: https://${{ secrets.ARVAN_BUCKET_NAME }}.s3-website.ir-thr-at1.arvanstorage.ir/
        
        ### â° Deployment Time
        
        Completed at: $(date -u '+%Y-%m-%d %H:%M UTC')
        EOF

    # ==================== NOTIFICATION ====================
    - name: ðŸ“¢ Deployment Failed Notification
      if: failure()
      run: |
        echo "âŒ Deployment failed!"
        echo "Check the logs above for details."
        exit 1