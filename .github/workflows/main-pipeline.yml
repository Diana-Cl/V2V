name: 'V2V Publisher - Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ùˆ Ø§Ù†ØªØ´Ø§Ø± Ú†Ù†Ø¯-Ø¢ÛŒÙ†Ù‡â€ŒØ§ÛŒ'

on:
  # Ø§Ø¬Ø±Ø§ Ù‡Ø± 3 Ø³Ø§Ø¹Øª ÛŒÚ©Ø¨Ø§Ø±
  schedule:
    - cron: '0 */3 * * *' 
  workflow_dispatch:

jobs:
  scrape_and_commit:
    runs-on: ubuntu-latest
    environment: Production 
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 

    - name: Setup Python environment
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests PyGithub PyYAML

    - name: Execute Scraper script
      run: python scraper.py
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
        # âœ… Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Cloudflare (Ø¨Ø±Ø§ÛŒ KV) Ø¨Ù‡ Ø·ÙˆØ± Ú©Ø§Ù…Ù„ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯ØŒ Ø²ÛŒØ±Ø§ WorkerÙ‡Ø§ Ù…Ø³Ø¦ÙˆÙ„ÛŒØª Ø¢Ù¾Ù„ÙˆØ¯ Ø±Ø§ Ø¨Ø± Ø¹Ù‡Ø¯Ù‡ Ø¯Ø§Ø±Ù†Ø¯.

    - name: Configure Git for commit
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
    - name: Commit and Push new files (GitHub Mirror)
      run: |
        # âœ… Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† index.html Ùˆ index.js Ø¨Ø±Ø§ÛŒ Deploy Ø´Ø¯Ù† Ú©Ø¯Ù‡Ø§ÛŒ UI Ø¬Ø¯ÛŒØ¯
        git add index.html index.js all_live_configs.json clash_subscription.yml cache_version.txt
        if git diff --cached --exit-code; then
          echo "No files to commit. Skipping."
        else
          git commit -m "ğŸ¤– V2V Scraper: Update configs, cache version, and UI files [skip ci]"
          git push
        fi
        
  multi_mirror_deploy:
    runs-on: ubuntu-latest
    # Ø§ÛŒÙ† Job ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª Ù…ÙˆÙÙ‚ÛŒØª Job Ù‚Ø¨Ù„ÛŒ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
    needs: scrape_and_commit
    
    steps:
    - name: Checkout code (Fetch committed files)
      # Ø§ÛŒÙ† Ú¯Ø§Ù… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ (Ø§Ø² Ø¬Ù…Ù„Ù‡ index.html Ùˆ index.js) Ø±Ø§ Ù¾Ø³ Ø§Ø² Commit Ø´Ø¯Ù† Ù…ÛŒâ€ŒØ¢ÙˆØ±Ø¯.
      uses: actions/checkout@v4

    # Deploy to Vercel Mirror (https://v2v-vercel.vercel.app/)
    - name: Deploy to Vercel Mirror
      id: vercel_deploy
      uses: amondnet/vercel-action@v25 
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'
      continue-on-error: true 

    # Deploy to Arvan Cloud Object Storage (https://v2v-data.s3-website.ir-thr-at1.arvanstorage.ir/)
    - name: Deploy to Arvan Cloud Object Storage (S3 Sync)
      id: arvan_deploy
      uses: jakejarvis/s3-sync-action@master
      with:
        # Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù† --delete ØªØ¶Ù…ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ (Ù…Ø§Ù†Ù†Ø¯ Base64) Ø­Ø°Ù Ø´ÙˆÙ†Ø¯.
        args: --acl public-read --delete 
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.ARVAN_ACCESS_KEY }} 
        AWS_SECRET_ACCESS_KEY: ${{ secrets.ARVAN_SECRET_ACCESS_KEY }}
        AWS_S3_ENDPOINT: 'https://s3.ir-thr-at1.arvanstorage.ir' 
        AWS_S3_BUCKET: ${{ secrets.ARVAN_BUCKET_NAME }} 
        SOURCE_DIR: '.'
      continue-on-error: true 
      
    # Final Deploy Status Report
    - name: Final Deploy Status Report
      if: always() 
      run: |
        vercel_status="${{ steps.vercel_deploy.outcome }}"
        arvan_status="${{ steps.arvan_deploy.outcome }}"

        echo "Deployment Status:"
        echo "- GitHub Pages: Success (Committed)"
        echo "- Vercel: $vercel_status (Consumer: Worker)"
        echo "- Arvan: $arvan_status (Consumer: Worker)"

        if [ "$vercel_status" == "failure" ] || [ "$arvan_status" == "failure" ]; then
            echo "âš ï¸ Warning: One or more mirrors failed. Pipeline continued."
            echo "ğŸ”¥ Consumers (Workers) will use active mirrors."
        else
            echo "âœ… Success: All mirrors updated successfully."
        fi
