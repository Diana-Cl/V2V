name: 'V2V Publisher - ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ Ÿà ÿßŸÜÿ™ÿ¥ÿßÿ± ⁄ÜŸÜÿØ-ÿ¢€åŸÜŸá‚Äåÿß€å'

on:
  schedule:
    - cron: '0 */3 * * *' 
  workflow_dispatch:

jobs:
  scrape_and_commit:
    runs-on: ubuntu-latest
    environment: Production 
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 

    - name: Setup Python environment
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests PyGithub PyYAML

    - name: Execute Scraper script
      run: python scraper.py
      env:
        GH_PAT: ${{ secrets.GH_PAT }}

    - name: Configure Git for commit
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
    - name: Commit and Push new files (GitHub Mirror)
      run: |
        git add all_live_configs.json clash_subscription.yml cache_version.txt
        if git diff --cached --exit-code; then
          echo "No files to commit. Skipping."
        else
          git commit -m "ü§ñ V2V Scraper: Update configs and cache version [skip ci]"
          git push
        fi
        
  multi_mirror_deploy:
    runs-on: ubuntu-latest
    needs: scrape_and_commit
    
    steps:
    - name: Checkout code (Fetch committed files)
      uses: actions/checkout@v4

    # Deploy to Vercel Mirror (https://v2v-vercel.vercel.app/)
    - name: Deploy to Vercel Mirror
      id: vercel_deploy
      uses: amondnet/vercel-action@v25 
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'
      continue-on-error: true 

    # Deploy to Arvan Cloud Object Storage (https://v2v-data.s3-website.ir-thr-at1.arvanstorage.ir/)
    - name: Deploy to Arvan Cloud Object Storage (S3 Sync)
      id: arvan_deploy
      uses: jakejarvis/s3-sync-action@master
      with:
        args: --acl public-read --delete 
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.ARVAN_ACCESS_KEY }} 
        AWS_SECRET_ACCESS_KEY: ${{ secrets.ARVAN_SECRET_ACCESS_KEY }}
        AWS_S3_ENDPOINT: 'https://s3.ir-thr-at1.arvanstorage.ir' 
        AWS_S3_BUCKET: ${{ secrets.ARVAN_BUCKET_NAME }} 
        SOURCE_DIR: '.'
      continue-on-error: true 
      
    # Final Deploy Status Report
    - name: Final Deploy Status Report
      if: always() 
      run: |
        vercel_status="${{ steps.vercel_deploy.outcome }}"
        arvan_status="${{ steps.arvan_deploy.outcome }}"

        echo "Deployment Status:"
        echo "- GitHub Pages: Success (Committed)"
        echo "- Vercel: $vercel_status (Consumer: Worker)"
        echo "- Arvan: $arvan_status (Consumer: Worker)"

        if [ "$vercel_status" == "failure" ] || [ "$arvan_status" == "failure" ]; then
            echo "‚ö†Ô∏è Warning: One or more mirrors failed. Pipeline continued."
            echo "üî• Consumers (Workers) will use active mirrors."
        else
            echo "‚úÖ Success: All mirrors updated successfully."
        fi
