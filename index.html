<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Ø±ÙˆÚ˜Ù‡ V2V</title>
    <style>
        :root {
            --primary-bg: #121212; --secondary-bg: #1a1a1a; --text-color: #d1d1d1;
            --logo-red: #D32F2F; --logo-green: #388E3C; --border-color: #333;
        }
        html { height: 100%; box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }
        body {
            background-color: var(--primary-bg); color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            text-align: center; margin: 0; display: flex; flex-direction: column;
            align-items: center; min-height: 100%;
        }
        .main-wrapper {
            width: 100%; max-width: 700px; padding: 20px 10px;
            display: flex; flex-direction: column; flex-grow: 1;
        }
        .header { margin-bottom: 20px; flex-shrink: 0; }
        .header img { width: 100px; height: 100px; }
        .container {
            width: 100%; background-color: var(--secondary-bg); padding: 20px;
            border-radius: 10px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }
        .core-header {
            color: white; padding: 15px; border-radius: 8px; font-size: 1.3em;
            font-weight: bold; margin-bottom: 20px;
        }
        #xray-header { background-color: var(--logo-red); }
        #singbox-header { background-color: var(--logo-green); }
        .test-button {
            background-color: var(--logo-green); color: white; border: none; padding: 10px 20px;
            border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1em; margin-bottom: 20px;
        }
        .action-group { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .action-group-title { margin: 0 0 15px 0; font-size: 1.1em; text-align: right; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .action-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .action-button { background-color: #333; border: 1px solid var(--border-color); padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9em; flex-grow: 1; color: var(--text-color); }
        .protocol-group { border-top: 1px solid var(--border-color); }
        .protocol-header { background-color: transparent; padding: 15px 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .config-list { list-style: none; padding: 0; margin: 0; max-height: 0; transition: max-height 0.3s ease-out; overflow: hidden; }
        .protocol-group.open .config-list { max-height: 2000px; }
        .config-item { padding: 15px 5px; border-top: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px; }
        .config-details { flex-grow: 1; text-align: right; overflow: hidden; }
        .config-details .server { font-weight: bold; word-break: break-all; font-size: 0.9em; }
        .copy-button-container { display: flex; gap: 10px; }
        .copy-btn { background-color: #333; border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 5px; cursor: pointer; color: var(--text-color); }
        .bottom-links { margin-top: auto; padding-top: 20px; border-top: 2px solid var(--border-color); width: 100%; display: flex; gap: 20px; justify-content: center; flex-shrink: 0; }
        .bottom-links a { color: var(--text-color); text-decoration: none; font-size: 0.9em; }
        .alert { padding: 20px; font-weight: bold; color: var(--logo-red); }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <div class="header">
            <img src="https://raw.githubusercontent.com/SMBCRYP/V2V/main/logo.png" alt="V2V Logo">
            <p>Ø³Ù¾Ø§Ø³ Ù‡Ø±Ø¢Ù†Ú©Ù‡ Ø®ÙˆØ§Ù‡ ÛŒØ§ Ù†Ø§Ø®ÙˆØ§Ù‡ Ø¯Ø³ØªÛŒ Ø¨Ø± Ø§ÛŒÙ† Ø±Ø§Ù‡Ú© Ø±Ù‡Ø§ÛŒÛŒ Ø¯Ø§Ø´Øª</p>
        </div>
        <div class="container">
            <div id="xray-section">
                <div class="core-header" id="xray-header">Xray-Core / Ø§ÛŒÚ©Ø³â€ŒØ±ÛŒ</div>
                <div id="xray-content-wrapper"><div class="alert">Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div></div>
            </div>
            <div id="singbox-section">
                <div class="core-header" id="singbox-header">Sing-box Core / Ø³ÛŒÙ†Ú¯â€ŒØ¨Ø§Ú©Ø³</div>
                <div id="singbox-content-wrapper"><div class="alert">Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div></div>
            </div>
        </div>
        <div class="bottom-links">
            <a href="https://smbcryp.github.io/V2V/" target="_blank">GitHub</a>
            <a href="https://v2-v.vercel.app/" target="_blank">Vercel</a>
            <a href="https://v2v-data.s3-website.ir-thr-at1.arvanstorage.ir" target="_blank">ArvanCloud</a>
        </div>
    </div>
    
    <script>
        let allConfigs = { xray: [], singbox: [] };
        const DATA_SOURCES = [
            'https://smbcryp.github.io/V2V/all_live_configs.json',
            'https://v2-v.vercel.app/all_live_configs.json',
            'https://v2v-data.s3-website.ir-thr-at1.arvanstorage.ir/all_live_configs.json'
        ];
        
        async function fetchDataWithFallback() {
            for (const url of DATA_SOURCES) {
                try {
                    const response = await fetch(url, { cache: "no-store" });
                    if (!response.ok) throw new Error(`Status: ${response.status}`);
                    return await response.json();
                } catch (error) { console.error(`Failed: ${url}`, error); }
            }
            throw new Error('All data sources failed.');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const data = await fetchDataWithFallback();
                allConfigs = data;
                renderCore('xray');
                renderCore('singbox');
            } catch (error) {
                const errorMsg = `<div class="alert">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ø§Ø² ØªÙ…Ø§Ù… Ù…Ù†Ø§Ø¨Ø¹.</div>`;
                document.getElementById('xray-content-wrapper').innerHTML = errorMsg;
                document.getElementById('singbox-content-wrapper').innerHTML = errorMsg;
            }
        });

        function renderCore(core) {
            const container = document.getElementById(`${core}-content-wrapper`);
            const configs = allConfigs[core] || [];
            container.innerHTML = '';
            
            const headerControls = document.createElement('div');
            headerControls.innerHTML = `<button class="test-button" onclick="runSpeedTest('${core}')">ğŸš€ ØªØ³Øª Ø³Ø±Ø¹Øª</button>`;
            container.appendChild(headerControls);

            if (configs.length === 0) {
                const noConfigAlert = document.createElement('div');
                noConfigAlert.className = 'alert';
                noConfigAlert.innerHTML = 'âŒ Ù‡ÛŒÚ† Ú©Ø§Ù†ÙÛŒÚ¯ Ø¨Ø§Ù„Ù‚ÙˆÙ‡ Ø³Ø§Ù„Ù…ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù…Ù†ØªØ¸Ø± Ø¢Ù¾Ø¯ÛŒØª Ø¨Ø¹Ø¯ÛŒ Ù…Ù†Ø§Ø¨Ø¹ Ø¨Ù…Ø§Ù†ÛŒØ¯.';
                container.appendChild(noConfigAlert);
                return;
            }

            const groupedByProtocol = configs.reduce((acc, config) => {
                try {
                    const protocol = new URL(config.config_str).protocol.slice(0, -1);
                    if (!acc[protocol]) acc[protocol] = [];
                    acc[protocol].push(config);
                } catch (e) {}
                return acc;
            }, {});

            for (const protocol in groupedByProtocol) {
                const protocolGroupId = `${protocol}-${core}`;
                const protocolGroup = document.createElement('div');
                protocolGroup.className = 'protocol-group';
                const protocolHeader = document.createElement('div');
                protocolHeader.className = 'protocol-header';
                protocolHeader.onclick = () => toggleGroup(protocolGroupId);
                protocolHeader.innerHTML = `<span>${protocol.toUpperCase()} (${groupedByProtocol[protocol].length})</span><span>&#9660;</span>`;
                
                const configList = document.createElement('ul');
                configList.className = 'config-list';
                configList.id = protocolGroupId;
                groupedByProtocol[protocol].forEach(config => {
                    const serverName = config.config_str.includes('#') ? decodeURIComponent(config.config_str.split('#')[1]) : new URL(config.config_str).hostname;
                    const li = document.createElement('li');
                    li.className = 'config-item';
                    li.dataset.config = config.config_str;
                    const initialPing = (config.ping === 'N/A') ? 'ØªØ³Øª Ù†Ø´Ø¯Ù‡' : `Ù¾ÛŒÙ†Ú¯ Ø§ÙˆÙ„ÛŒÙ‡: ${config.ping}ms`;
                    li.innerHTML = `
                        <div class="config-details">
                            <span class="server">${serverName}</span>
                            <span class="ping">${initialPing}</span>
                        </div>
                        <div class="copy-button-container">
                            <button class="copy-btn" onclick="copyToClipboard('${config.config_str}')">Ú©Ù¾ÛŒ</button>
                        </div>`;
                    configList.appendChild(li);
                });
                
                protocolGroup.appendChild(protocolHeader);
                protocolGroup.appendChild(configList);
                container.appendChild(protocolGroup);
            }
        }
        
        function toggleGroup(groupId) {
            const list = document.getElementById(groupId);
            if (list) list.parentNode.classList.toggle('open');
        }
        
        async function runSpeedTest(core) {
            const testButton = document.querySelector(`#${core}-section .test-button`);
            testButton.disabled = true; testButton.textContent = 'Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª...';
            
            const items = document.querySelectorAll(`#${core}-content-wrapper .config-item`);
            
            // Batch processing for frontend test
            const batchSize = 10;
            const batches = [];
            for (let i = 0; i < items.length; i += batchSize) {
                batches.push(Array.from(items).slice(i, i + batchSize));
            }

            for (const batch of batches) {
                await Promise.all(batch.map(async item => {
                    item.style.opacity = '0.5';
                    const pingEl = item.querySelector('.ping');
                    const ping = await testConfigLatency(item.dataset.config);
                    
                    item.dataset.newPing = (ping !== 'Timeout' && ping !== 'Error') ? ping : 9999;
                    pingEl.innerHTML = `Ù¾ÛŒÙ†Ú¯: <strong style="color:${(item.dataset.newPing < 9999) ? 'var(--logo-green)' : 'var(--logo-red)'};">${ping}ms</strong>`;
                    item.style.opacity = '1';
                }));
            }
            
            sortConfigsByPing(core);
            testButton.disabled = false; testButton.textContent = 'ğŸš€ ØªØ³Øª Ù…Ø¬Ø¯Ø¯';
        }

        function testConfigLatency(configStr) {
            return new Promise(async resolve => {
                const controller = new AbortController();
                setTimeout(() => { controller.abort(); resolve('Timeout'); }, 5000);
                try {
                    const parsed_url = new URL(configStr);
                    let details = null;
                    if (parsed_url.protocol === 'vmess:') {
                        const decoded = JSON.parse(atob(configStr.replace('vmess://', '')));
                        details = { host: decoded.add, port: parseInt(decoded.port) };
                    } else if (parsed_url.hostname) {
                        details = { host: parsed_url.hostname, port: parseInt(parsed_url.port || 443) };
                    }
                    if (!details) return resolve('Error');
                    const response = await fetch('https://v2-v.vercel.app/api/proxy', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(details), signal: controller.signal });
                    if (!response.ok) return resolve('Error');
                    const data = await response.json();
                    resolve(data.ping < 9999 ? data.ping : 'Timeout');
                } catch (e) { resolve('Error'); }
            });
        }
        
        function sortConfigsByPing(core) {
            const container = document.getElementById(`${core}-content-wrapper`);
            const groups = container.querySelectorAll('.protocol-group');
            groups.forEach(group => {
                const list = group.querySelector('.config-list');
                const items = Array.from(list.children);
                items.sort((a, b) => (a.dataset.newPing || 9999) - (b.dataset.newPing || 9999));
                items.forEach(item => list.appendChild(item));
            });
        }

        function copyToClipboard(text, msg = 'Ú©Ù¾ÛŒ Ø´Ø¯!') { navigator.clipboard.writeText(text).then(() => alert(msg)); }
    </script>
</body>
</html>
