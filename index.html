<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پروژه V2V</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Vazirmatn', sans-serif;
            text-align: center;
        }
        .container {
            max-width: 900px;
            margin-top: 20px;
        }
        .header {
            background-color: #1f1f1f;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .config-card {
            background-color: #1f1f1f;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            text-align: right;
            border: 1px solid #333;
            transition: border-color 0.3s;
        }
        .config-card:hover {
            border-color: #4CAF50;
        }
        .core-select-btn, .action-btn {
            background-color: #333;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 10px;
            cursor: pointer;
            margin: 5px;
            width: 150px;
        }
        .core-select-btn.active {
            background-color: #4CAF50;
        }
        .action-btn.copy { background-color: #555; }
        .action-btn.test { background-color: #f44336; }
        .loading {
            color: #888;
        }
        .ping-loading {
            color: #888;
        }
        .ping-ok {
            color: #4CAF50;
        }
        .ping-high {
            color: #ff9800;
        }
        .ping-fail {
            color: #f44336;
        }
        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
        }
        #pingStatus {
            margin-top: 10px;
        }
        #pingStatus div {
            margin-bottom: 5px;
        }
        .subscription-link-btn {
            background-color: #007bff;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        .download-btn {
            background-color: #2196F3;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1 class="mb-3">پروژه V2V</h1>
            <div class="d-flex justify-content-center mb-3">
                <button class="core-select-btn active" data-core="xray">Xray</button>
                <button class="core-select-btn" data-core="singbox">Singbox</button>
            </div>
            <div class="d-flex justify-content-center flex-wrap mb-3">
                <button class="action-btn copy-all-btn" data-core="xray">کپی همه Xray</button>
                <button class="action-btn download-btn" data-core="xray">دانلود Xray</button>
                <button class="action-btn copy-all-btn" data-core="singbox">کپی همه Singbox</button>
                <button class="action-btn download-btn" data-core="singbox">دانلود Singbox</button>
            </div>
            <div class="input-group mb-3">
                <input type="text" id="searchInput" class="form-control" placeholder="جستجوی کانفیگ..." aria-label="جستجو">
            </div>
            <button class="subscription-link-btn" id="showSubscriptionLink">لینک سابسکریپشن</button>
        </div>

        <div id="configsContainer">
            <div class="d-flex justify-content-center">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const configsContainer = document.getElementById('configsContainer');
            const coreSelectBtns = document.querySelectorAll('.core-select-btn');
            const searchInput = document.getElementById('searchInput');
            const copyAllBtns = document.querySelectorAll('.copy-all-btn');
            const downloadBtns = document.querySelectorAll('.download-btn');
            const showSubscriptionLinkBtn = document.getElementById('showSubscriptionLink');
            
            let allConfigs = { xray: [], singbox: [] };
            let currentCore = 'xray';
            
            const API_BASE_URL = window.location.origin + '/api/';
            
            // Function to fetch configurations
            const fetchConfigs = async () => {
                configsContainer.innerHTML = `<div class="d-flex justify-content-center"><div class="spinner-border text-success" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
                try {
                    const response = await fetch('all_live_configs.json');
                    if (!response.ok) {
                        throw new Error('Failed to load configs');
                    }
                    const data = await response.json();
                    allConfigs = data;
                    renderConfigs();
                } catch (error) {
                    configsContainer.innerHTML = `<div class="alert alert-danger" role="alert">خطا در بارگذاری کانفیگ‌ها. لطفاً بعداً دوباره امتحان کنید.</div>`;
                    console.error("Error fetching configs:", error);
                }
            };
            
            // Function to render configurations
            const renderConfigs = () => {
                const configs = allConfigs[currentCore];
                const searchTerm = searchInput.value.toLowerCase();
                
                let filteredConfigs = configs;
                if (searchTerm) {
                    filteredConfigs = configs.filter(c => c.config_str.toLowerCase().includes(searchTerm));
                }
                
                configsContainer.innerHTML = '';
                if (filteredConfigs.length === 0) {
                    configsContainer.innerHTML = `<div class="alert alert-warning" role="alert">کانفیگی برای نمایش وجود ندارد.</div>`;
                    return;
                }
                
                filteredConfigs.forEach((config, index) => {
                    const configElement = document.createElement('div');
                    configElement.className = 'config-card';
                    
                    const protocol = config.config_str.split('://')[0];
                    const protocolIcon = protocol === 'vless' ? 'v' : (protocol === 'trojan' ? 't' : (protocol === 'vmess' ? 'vm' : protocol));
                    
                    configElement.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <span>
                                <strong style="color: #4CAF50;">#${index + 1}</strong>
                                <span class="protocol-icon">${protocolIcon.toUpperCase()}</span>
                                <span class="d-inline-block text-truncate" style="max-width: 60%;">
                                    ${config.config_str.split('#')[1] || config.config_str.split('://')[1].substring(0, 30) + '...'}
                                </span>
                            </span>
                            <div class="d-flex align-items-center">
                                <span class="ping-display ms-3">
                                    <i class="fas fa-signal"></i>
                                    <span class="ms-1">${config.ping}ms</span>
                                </span>
                                <button class="btn btn-sm btn-outline-light copy-btn" data-config="${config.config_str}">
                                    <i class="far fa-copy"></i>
                                </button>
                                <a href="${config.config_str}" class="btn btn-sm btn-outline-light ms-2">
                                    <i class="fas fa-external-link-alt"></i>
                                </a>
                            </div>
                        </div>
                    `;
                    configsContainer.appendChild(configElement);
                });
            };
            
            // Event listeners
            coreSelectBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    coreSelectBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCore = btn.dataset.core;
                    renderConfigs();
                });
            });
            
            searchInput.addEventListener('input', renderConfigs);
            
            configsContainer.addEventListener('click', (e) => {
                if (e.target.closest('.copy-btn')) {
                    const btn = e.target.closest('.copy-btn');
                    const configToCopy = btn.dataset.config;
                    navigator.clipboard.writeText(configToCopy)
                        .then(() => {
                            btn.innerHTML = '<i class="fas fa-check"></i>';
                            setTimeout(() => {
                                btn.innerHTML = '<i class="far fa-copy"></i>';
                            }, 2000);
                        })
                        .catch(err => {
                            console.error('Failed to copy text: ', err);
                        });
                }
            });
            
            copyAllBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const coreToCopy = btn.dataset.core;
                    if (coreToCopy !== currentCore) return;
                    
                    const configs = allConfigs[coreToCopy];
                    const fullText = configs.map(c => c.config_str).join('\n');
                    
                    navigator.clipboard.writeText(fullText)
                        .then(() => {
                            btn.innerHTML = '<i class="fas fa-check me-2"></i>کپی شد';
                            setTimeout(() => {
                                btn.innerHTML = btn.dataset.core === 'xray' ? 'کپی همه Xray' : 'کپی همه Singbox';
                            }, 2000);
                        })
                        .catch(err => {
                            console.error('Failed to copy all configs: ', err);
                        });
                });
            });
            
            downloadBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const coreToDownload = btn.dataset.core;
                    if (coreToDownload !== currentCore) return;

                    const configs = allConfigs[coreToDownload];
                    const content = configs.map(c => c.config_str).join('\n');
                    const base64Content = btoa(content);
                    const dataUri = `data:text/plain;base64,${base64Content}`;

                    const link = document.createElement('a');
                    link.href = dataUri;
                    link.download = `${coreToDownload}_configs.txt`;
                    link.click();
                });
            });

            showSubscriptionLinkBtn.addEventListener('click', async () => {
                const configs = allConfigs[currentCore];
                if (configs.length === 0) {
                    alert('هیچ کانفیگی برای ساخت لینک سابسکریپشن وجود ندارد.');
                    return;
                }

                const fullText = configs.map(c => c.config_str).join('\n');
                const base64Text = btoa(fullText);

                const link = `data:text/plain;base64,${base64Text}`;
                
                // Copy the link to clipboard
                try {
                    await navigator.clipboard.writeText(link);
                    alert('لینک سابسکریپشن با موفقیت کپی شد!');
                } catch (err) {
                    console.error('Failed to copy subscription link: ', err);
                    alert('خطا در کپی لینک. لطفاً به صورت دستی کپی کنید: ' + link);
                }
            });
            
            fetchConfigs();
        });
    </script>
</body>
</html>
